<ng-container *ngIf="authService.currentUser | async as user">
  <div class="calendar-container">
    <mat-form-field *ngIf="user.role != 'doctor'">
      <mat-label>Select Doctor</mat-label>
      <mat-select [(ngModel)]="selectedDoctorId" (selectionChange)="loadData()">
        <mat-option
          *ngFor="let doctor of doctors$ | async"
          [value]="doctor.uid"
        >
          {{ doctor.displayName }}, {{ doctor.doctorDetails?.specialization }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <div *ngIf="user.role === 'doctor'" class="doctor-actions">
      <button mat-raised-button routerLink="/calendar/availability">
        Dodaj dostępność
      </button>
      <button mat-raised-button routerLink="/calendar/absence">
        Dodaj nieobecność
      </button>
    </div>

    <div class="week-nav">
      <button mat-button (click)="previousWeek()">Previous</button>
      <span>{{ currentDate | date }}</span>
      <button mat-button (click)="nextWeek()">Next</button>
    </div>

    <table class="calendar-grid">
      <tr>
        <th></th>
        <th
          *ngFor="let day of weekDays"
          [class.today-column]="isTodayCell(day)"
        >
          <div class="column-header">
            {{ day | date : "EEE" }}, {{ day | date : "dd.MM" }}
            <div class="appointment-count">
              Wizyt: {{ getAppointmentCountForDay(day) }}
            </div>
          </div>
        </th>
      </tr>

      <tr *ngFor="let slot of timeSlots">
        <td class="time-cell" [class.current-time]="isCurrentTimeSlot(slot)">
          {{ slot }}
        </td>
        <td
          *ngFor="let day of weekDays"
          class="slot-cell"
          [class.past]="isPast(day, slot)"
          [class.available]="isAvailable(day, slot)"
          [class.booked]="isBooked(day, slot)"
          [class.absence]="isDoctorAbsent(day)"
          (click)="onSlotClick(day, slot)"
        >
          <ng-container *ngIf="getAppointment(day, slot) as appt">
            <div class="appointment-info">
              <ng-container *ngIf="user.role === 'doctor'; else patientView">
                {{ appt.patientName }}
                <small>({{ appt.patientGender }}, {{ appt.patientAge }})</small>
                <div>{{ appt.notes }}</div>
              </ng-container>
              <ng-template #patientView>
                <div>Booked</div>
              </ng-template>
              <small>({{ appt.status }})</small>
            </div>
          </ng-container>
        </td>
      </tr>
    </table>
  </div>
</ng-container>
